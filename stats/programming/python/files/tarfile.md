# Работа с tar-архивами в Python

![tarfile](https://image.flaticon.com/icons/png/128/29/29534.png) Многим пользователям потребуется распаковывать, запаковывать и читать содержимое tar-архива в скриптах Python. Модуль `tarfile` как раз для этого предназначен.

## Возможности:

- Чтение и запись `gzip`-, `bzip2`-, `lzma`-архивов.
- Поддержка чтения/записи POSIX.1-1988 (он же `ustar`).
- Поддержка чтения/записи для формата GNU tar, включая расширения длинных имен и длинных ссылок, поддержка только для чтения всех вариантов разреженных файлов, включая их восстановление.
- И многое другое.

## Unicode

`tar` изначально предназначался для создания резервных копий на *ленточных* носителях с основным упором на сохранение информации об ФС. Но сейчас такие архивы используются для распространения и обмена файлами. Одна из проблем данного формата - не существует концепции поддержки различных кодировок символов. К примеру, обычный архив, созданный в UTF-8 системе, не будет корректно прочинан в системе Latin-1, если он содержит не-ASCII символы. Текстовые метаданные будут выглядеть повреждёнными. Нет способа автоматически определить кодировку архива.

Для решения данной проблемы был разработан формат `pax`, хранящий данные не в ASCII, а использующий универсальную кодировку UTF-8. И в модуле `tarfile` по умолчанию используется `PAX_FORMAT`.

## Открытие

Как и в предыдущих примерах, здесь нужно открыть нужный файл. Но открытие производится не с помощью стандартной функции `open()`, а с помощью `open()` из модуля `tarfile`. После чего производятся некоторые действия, и архив закрывается функцией `close()`.

Для `open()` нужно указать файл и режим работы. Режимы работы в таблице ниже:

| Режим | Расшифровка |
|-------|-------------|
| `r`   | Открыть для чтения с прозрачным сжатием |
| `r:`  | Открыть для чтения исключительно без сжатия |
| `r:gz` | Открыть для чтения со сжатием `gzip` |
| `r:bz2` | Открыть для чтения со сжатием `bzip2` |
| `r:xz` | Открыть для чтения со сжатием `xz` (`lzma`) |
| `x` | Создать файл без сжатия, либо со сжатием `gz`. Вызывает исключение `FileExistsError`, если он уже существует (тоже самое и с последующими `x*`) |
| `x:gz` | Создать файл со сжатием `gzip` |
| `x:bz2` | Создать файл со сжатием `bzip2` |
| `x:xz` | Создать файл со сжатием `lzma` |
| `a` | Открыть файл для добавления без сжатия. Если файла не существует, создаётся новый. |
| `w` | Открыть для записи с предварительной очисткой |
| `w:gz` | Открыть для записи с предварительной очисткой со сжатием `gzip` |
| `w:bz2` | Открыть файл для записи ... со сжатием `bzip2` |
| `w:xz` | Открыть файл для записи ... со сжатием `lzma` |

> **ВНИМАНИЕ!**

> Варианты `a:gz`, `a:bz2`, `a:xz` невозможны.

## Возможные исключения

- `TarError` - базовый класс всех исключений tarfile.
- Если режим работы не подходит для открытия определённого сжатого файла для чтения, возникнет исключение `ReadError`.
- Если метод сжатия не поддерживается, возникнет исключение `CompressionError`.
- `StreamError` - вызывается для ограничений, типичный для потоковых объектов tarfile.
- `ExtractError` - поднимается для несмертельных ошибок при использовании функции `extract()`, но **только** если `errorlevel = 2`.
- `HeaderError` - вызывается `TarInfo.frombuf()`, если полученный буфер недействителен.

## Константы, определяющие возможные форматы архивов, с которыми может работать модуль

- `USTAR_FORMAT` - POSIX.1-1988 (ustar).
- `GNU_FORMAT` - GNU `tar` формат.
- `PAX_FORMAT` - POSIX.1-2001 (pax).
- `DEFAULT_FORMAT` - дефолтный формат. По умолчанию `DEFAULT_FORMAT = PAX_FORMAT`.

## Проверка на возможность открытия и дальнейших манипуляций с архивом

Функция `is_tarfile()` возвращает истину, если аргумент является tar-файлом, возвращает ложь, если не является. Синтаксис:

```python
>>> tarfile.is_tarfile(name)
True
```

Где `name` - имя архива.

## Создание tar-архива

Для создания архива нужно открыть архив в режиме записи, а затем добавить в него нужные файлы.

```python
#!/usr/bin/python

import tarfile

file = "some.tar" # Имя файла
file_obj = tarfile.open(file, "w") # Открытие архива

# Добавление файлов
file_obj.add("some.md")
file_obj.add("some.png")
file_obj.add("/usr/bin/dnf")

file_obj.close() # Закрытие файла
```

Здесь функция `tarfile.open()` принимает два аргумента - имя архива, который нужно открыть, и права доступа. Для того, чтобы ***добавить*** файлы в уже *существующий* архив, замените `"w"` на `"a"`.

Метод `add()` добавляет нужные файлы в архив. Синтаксис:

```python
file.add("file")
```

Где `file` - нужная переменная, а `"file"` - файл, который нужно добавить в архив `file`.

## Вывод содержимого tar-архива

* Первый способ.

С помощью `getnames()`.

```python
#!/usr/bin/python3

import tarfile

file = "some.tar" # Имя файла
file_obj = tarfile.open(file, "w") # Открытие архива
file_list = file_obj.getnames()

# Вывод содержимого архива в stdout
for name in file_list:
	print(name)

file_obj.close()
```

* Второй способ.

С помощью `list()`.

```python
#!/usr/bin/python3

import tarfile

file = "some.tar" # Имя файла
file_obj = tarfile.open(file, "w") # Открытие архива

file_obj.list(verbose=True, members=None)

file_obj.close()
```

Если `verbose=False`, то выводятся только имена элементов. Если `True`, то вывод аналогичен `ls -l`. Если указан необязательный `members`, он должен быть подмножеством списка, возвращаемого `getmembers()`.

## Распаковка tar-архива в текущий рабочий каталог

### Распаковка всех файлов

Чтобы извлечь все файлы из архива используется функция `tarfile.extractall()`. Она принимает имя директории, в которую впоследствии будет распакован архив. Если этот аргумент не указать, то архив будет распакован в текущий рабочий каталог.

```python
#!/usr/bin/python3

import tarfile

tar = tarfile.open("some.txz")
tar.extractall()

tar.close()
```

> **ВНИМАНИЕ!**

> Никогда не извлекайте архивы из ненадёжных источников без предварительной проверки. Возможно, файлы созданы вне `path`, например, элементы, которые имеют абсолютные имена файлов, начинающихся с `/`, или имена файлов с двумя точками: `..`.

### Распаковка определённого файлая

Для того, чтобы извлечь только один или несколько других файлов используется функция `tarfile.extractfile()`. В качестве аргумента она принимает имя файла и извлекает его в текущий рабочий каталог.

```python
#!/usr/bin/python3

import tarfile

tar = tarfile.open("some.txz")
file = tar.extractfile("myfile.txt") # Распаковка файла myfile.txt

tar.close()
```

## Смотрите также:

- `zipfile` - для работы с zip-архивами.
- `shutil` - для копирования, перемещения, переименования файлов и работы с архивами.
