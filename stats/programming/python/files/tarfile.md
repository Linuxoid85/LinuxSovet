# Работа с tar-архивами в Python

Многим пользователям потребуется распаковывать, запаковывать и читать содержимое tar-архива в скриптах Python. Модуль `tarfile` как раз для этого предназначен.

## Возможности:

- Чтение и запись `gzip`-, `bzip2`-, `lzma`-архивов.
- Поддержка чтения/записи POSIX.1-1988 (он же `ustar`).
- Поддержка чтения/записи для формата GNU tar, включая расширения длинных имен и длинных ссылок, поддержка только для чтения всех вариантов разреженных файлов, включая их восстановление.
- И многое другое.

## Unicode

`tar` изначально предназначался для создания резервных копий на *ленточных* носителях с основным упором на сохранение информации об ФС. Но сейчас такие архивы используются для распространения и обмена файлами. Одна из проблем данного формата - не существует концепции поддержки различных кодировок символов. К примеру, обычный архив, созданный в UTF-8 системе, не будет корректно прочинан в системе Latin-1, если он содержит не-ASCII символы. Текстовые метаданные будут выглядеть повреждёнными. Нет способа автоматически определить кодировку архива.

Для решения данной проблемы был разработан формат `pax`, хранящий данные не в ASCII, а использующий универсальную кодировку UTF-8. И в модуле `tarfile` по умолчанию используется `PAX_FORMAT`.

## Открытие

Как и в предыдущих примерах, здесь нужно открыть нужный файл. Но открытие производится не с помощью стандартной функции `open()`, а с помощью `open()` из модуля `tarfile`. После чего производятся некоторые действия, и архив закрывается функцией `close()`.

## Создание tar-архива

Для создания архива нужно открыть архив в режиме записи, а затем добавить в него нужные файлы.

```python
#!/usr/bin/python

import tarfile

file = "some.tar" # Имя файла
file_obj = tarfile.open(file, "w") # Открытие архива

# Добавление файлов
file_obj.add("some.md")
file_obj.add("some.png")
file_obj.add("/usr/bin/dnf")

file_obj.close() # Закрытие файла
```

Здесь функция `tarfile.open()` принимает два аргумента - имя архива, который нужно открыть, и права доступа. Их можно взять из статьи о работе с файлами. Для того, чтобы ***добавить*** файлы в уже *существующий* архив, замените `"w"` на `"a"`.

Метод `add()` добавляет нужные файлы в архив. Синтаксис:

```python
file.add("file")
```

Где `file` - нужная переменная, а `"file"` - файл, который нужно добавить в архив `file`.

## Вывод содержимого tar-архива

```python
#!/usr/bin/python3

import tarfile

file = "some.tar" # Имя файла
file_obj = tarfile.open(file, "w") # Открытие архива
file_list = file_obj.getnames()

# Вывод содержимого архива в stdout
for name in file_list:
	print(name)

file_obj.close()
```

## Распаковка tar-архива в текущий рабочий каталог

### Распаковка всех файлов

Чтобы извлечь все файлы из архива используется функция `tarfile.extractall()`. Она принимает имя директории, в которую впоследствии будет распакован архив. Если этот аргумент не указать, то архив будет распакован в текущий рабочий каталог.

```python
#!/usr/bin/python3

import tarfile

tar = tarfile.open("some.txz")
tar.extractall()

tar.close()
```

### Распаковка определённого файлая

Для того, чтобы извлечь только один или несколько других файлов используется функция `tarfile.extractfile()`. В качестве аргумента она принимает имя файла и извлекает его в текущий рабочий каталог.

```python
#!/usr/bin/python3

import tarfile

tar = tarfile.open("some.txz")
file = tar.extractfile("myfile.txt") # Распаковка файла myfile.txt

tar.close()
```

## Смотрите также:

- `zipfile` - для работы с zip-архивами.
- `shutil` - для копирования, перемещения, переименования файлов и работы с архивами.
