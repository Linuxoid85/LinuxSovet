# Сборка Calmira на 32-битной архитектуре (i386)

На протяжении нескольких месяцев я занимаюсь дистрибутивом [Calmira Linux](https://github.com/CalmiraLinux). Сейчас делаю его для себя и не планирую популяризировать и распространять где-нибудь. Позиционирую эту систему как небольшой легковесный дистрибутив для слабого железа. Но Calmira поддерживает только x86_64 архитектуру, но ещё есть ПК с i686 процессорами. Согласитесь - как-то не вяжется "легковесный", "для старого/слабого железа" и "несовместимый с i686".

Конечно, я понимаю, что i686 - устаревшая архитектура, и, по хорошему, надо бы от неё отказываться, но точно не в таком дистрибутиве. Да и такое "портирование" даст какой-никакой дополнительный опыт в сборке и администрировании ОС. Да и [issue](https://github.com/CalmiraLinux/CalmiraLinux/issues/42) говорит, что надо делать.

## Как собирается система?

Сейчас сборка Calmira полностью автоматизирована. Сборка с помощью [этого](https://github.com/CalmiraLinux/CalmiraLinux/blob/lx4/v1.1/src/makesystem/makesystem.sh) скрипта ([отсюда](https://github.com/CalmiraLinux/CalmiraLinux/tree/lx4/v1.1/src/makesystem)). Сам скрипт: `makesystem.sh`. Все остальные скрипты из директории мало интересуют, так как предназначены для более тонкой настройки программы. Больше всего интересует директория [`packages`](https://github.com/CalmiraLinux/CalmiraLinux/tree/lx4/v1.1/src/makesystem/packages), в которой находятся файлы с инструкциями по сборке пакетов системы.

Название файла соответствует названию нужного пакета. Это скрипты на `bash`, все инструкции взяты из руководства "Linux для себя" версии 1.3 ([ссылка](https://lx4u.ru/rel/1.3/#/)). Были некоторые изменения, например, более старые версии некоторых пакетов, но в целом, эти инструкции, как и сам дистрибутив, совместимы с LX4U.

Для сборки системы с помощью скрипта `makesystem.sh` требуется ввести следующие команды:

```bash
mkdir /var/log/{system-building,system_building} # Создание необходимых директорий с логами
./makesystem.sh
```

Скрипт автоматически соберёт все пакеты. В случае успешной сборки пакета скрипт выведет соответствующее сообщение и начнёт собирать следующий пакет. Если какой-то пакет собран неудачно, то скрипт выведет нужное сообщение и запросит у пользователя, продолжать ли сборку. При желании вы можете просмотреть каждый этап сборки пакета, так как всё перенаправляется в файл лога (отдельный лог для каждого пакета).

Потом скрипт запросит пароль пользователя `root`, диск, на который установлена система и его номер. Сборка завершится.

## Сборка временного инструментария

Для начала нужно самому собрать кросс-компилятор и несколько дополнительных утилит для сборки системы. К сожалению, то, что предоставляется для использования, предназначается для сборки только x86_64 системы. Поэтому вам нужно собрать свой тулчейн (временный инструментарий) для дальнейшего построения Calmira. Собирать по руководству [LX4U](https://lx4u.ru/rel/1.3/#) - так будет гарантирована достаточная для корректной сборки совместимость с Calmira. Не советуется для таких целей брать LFS, так как она не протестирована разработчиком Calmira.

Нужные пункты:

* [Сборка кросс-компилятора](https://lx4u.ru/rel/1.3/#/cross-toolchain/cross-toolchain)
* [Сборка заголовочных файлов ядра](https://lx4u.ru/rel/1.3/#/build-system/linux-headers)
* [Сборка временной системы](https://lx4u.ru/rel/1.3/#/build-temp-system/tempsystem)

## Замена команд

Несмотря на то, что собирать нужно по LX4, всё-таки, некоторые команды придётся изменить.

### Сборка кросс-компилятора - GCC

Замените команду:

```bash
sed -e '/m64=/s/lib64/lib/' \
    -e '/m32=/s/m32=.*/m32=..\/lib32$(call if_multiarch,:i386-linux-gnu)/' \
    -i.orig gcc/config/i386/t-linux64
```

На:

```bash
case $(uname -m) in
  x86_64)
    sed -e '/m64=/s/lib64/lib/' \
        -i.orig gcc/config/i386/t-linux64
 ;;
esac
```

Эта команда значит, если используется архитектура x86_64, то изменить ссылки для установки 64-битных директорий на `lib`. Если у хост-системы другая архитектура (к примеру, i686), то команда выполнена не будет.

### Сборка временной системы - Glibc

Замените:

```bash
ln -sfv ../lib/ld-linux-x86-64.so.2 $LIN/lib64
ln -sfv ../lib/ld-linux-x86-64.so.2 $LIN/lib64/ld-lsb-x86-64.so.3
```

На:

```bash
case $(uname -m) in
    i?86)   ln -sfv ld-linux.so.2 $LFS/lib/ld-lsb.so.3
    ;;
    x86_64) ln -sfv ../lib/ld-linux-x86-64.so.2 $LFS/lib64
            ln -sfv ../lib/ld-linux-x86-64.so.2 $LFS/lib64/ld-lsb-x86-64.so.3
    ;;
esac
```

Эта команда значит, если архитектура хост-системы x86_64, то будут созданы одни ссылки, а если i?86 (к примеру, i386, i686 и пр.) - то другие.

### Сборка временной системы - GCC

Замените:

```bash
sed -e '/m64=/s/lib64/lib/' \
    -e '/m32=/s/m32=.*/m32=..\/lib32$(call if_multiarch,:i386-linux-gnu)/' \
    -i.orig gcc/config/i386/t-linux64
```

На:

```bash
case $(uname -m) in
  x86_64)
    sed -e '/m64=/s/lib64/lib/' -i.orig gcc/config/i386/t-linux64
  ;;
esac
```

## Редактирование инструкций сборки скрипта makesystem

Так же нужно адаптировать некоторые скрипты из директории `packages` для корректной сборки для архитектуры i686. Это довольно просто, а файлов для редактирования не так много.

### packages/gcc

Приведите строку:

```bash
sed -e '/m64=/s/lib64/lib/' \
    -e '/m32=/s/m32=.*/m32=..\/lib32$(call if_multiarch,:i386-linux-gnu)/' \
    -i.orig gcc/config/i386/t-linux64
```

К следующему виду:

```bash
case $(uname -m) in
  x86_64)
    sed -e '/m64=/s/lib64/lib/' \
        -i.orig gcc/config/i386/t-linux64
  ;;
esac
```

Этим вы измените имя каталога по умолчанию на `lib` для 64-битных библиотек (только при сборке на x86_64). Для других архитектур этого выполнено не будет.


