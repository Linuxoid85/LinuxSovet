# Переключение раскладки в TTY. Более подробное продолжение предыдущей статьи.

Без клавиатуры невозможно представить себе персональный компьютер. С ПК мы работаем именно клавиатурой, а ничем иначе. А люди мы русскоязычные, поэтому одной английской раскладки не хватит, нужна ещё и русская. В графике мы просто переключаем раскладку комбинациями Alt+Shift, Ctrl+Shift, Super+Space, но не задумываемся о том, как это работает. Тем более не задумываемся, как это работает в TTY.

В этой статье я распишу о настройке клавиатуры в TTY. Если быть точным, о переключении раскладок. Да, уже есть статья об этом, но она весьма поверхностна, да и бОльшее внимание там уделено локализациям. Что ж, исправляю это.

Переключение раскладок в TTY может быть полезно в некоторых случаях. Например, лично я работаю исключительно в консоли, а не в графике. Если мне нужна какая-то графическая программа, то у меня есть отдельная система только для работы. А для всего остального у меня настроенная LFS. Без иксов и прочего. Чисто для души. Ну и эта статья была написана целиком и полностью на LFS.

## ТЗ
Постановка техзадания: настроить переключение раскладок клавиатуры в TTY. Сделать это на дистрибутиве LFS. Настройку производить в одном конфиг-файле.

Итак, все действия я буду выполнять на своём дистрибутиве [Calmira GNU/Linux](https://github.com/Linuxoid85/CalmiraLinux). Она собрана по LFS и совместима с ней. В том числе, настраивается точно так же.

## Теория
Как и всегда, начинаю с теории. Есть пакет `kbd`. Довольно полезная вещь, ведь он включает в себя программы `setfont`, `showconsolefont`, `loadkeys` и другие. В общем, содержит утилиты клавиатуры, таблицы ключей, консольные шрифты и пр. Некоторые файлы из этого пакета пригодятся в дальнейшем.

Помимо этого, есть файл `/etc/sysconfig/console`, в котором описываются настройки терминала (TTY). Его мы и будем редактировать. Как и описывалось в техзадании, только его, а ничто больше.

### /etc/sysconfig/console
Как было говорено выше, в этом файле описываются настройки терминала. В нём нужно отредактировать параметры `UNICODE`, `KEYMAP` и `FONT`.

Значения этих параметров просты:
* `UNICODE`: при значении 1, yes или true переводит консоль в режим UTF-8, что важно для русского языка.
* `KEYMAP`: аргументы для программы `loadkeys`, которая загружает раскладки клавиатуры. Соответственно, значение этого параметра равно имени загружаемой раскладке.
* `FONT`: аргументы для программы `setfont`, которая устанавливает шрифт терминала. Соответственно, значение этого параметра есть имя шрифта.

### /usr/share/consolefonts
В этой директории находятся консольные шрифты, которые мы и будем использовать.

### /usr/share/keymaps
В этой директории находятся раскладки клавиатуры. Лично мне нужна `/usr/share/keymaps/i386/qwerty`.

---

## Шрифт
Теперь сбор необходимых параметров. И начну со шрифтов. Все консольные шрифты находятся в директории `/usr/share/consolefonts`. Для того, чтобы просмотреть содержимое директории выполните:
```bash
ls /usr/share/consolefonts
```

> Лично я советую вам использовать шрифт `cyr-sun16`. Буквы понятные, всё различимо, русский поддерживается.

Для того, чтобы установить нужный шрифт, можно пойти двумя путями. Первый - это единоразово указать системе, какой шрифт использовать, а дальше он будет устанавливаться автоматически при запуске ОС. Второй - каждый раз вводить команду для использования определённого шрифта (можно записать её в `~/.bashrc` или `/etc/bashrc`). Так как статьи пишутся целиком и полностью для изучения Linux, будут описаны эти два способа.

> **Смотрите также:**

> `man setfont`

Для того, чтобы просмотреть некоторые символы, чтобы оценить поставленный нами шрифт, выполните:
```bash
showconsolefont
```

> **ВАЖНО!**

> Если выбрать шрифт, не поддерживающий русские символы, то работа в консоли будет очень неудобной. Учитывайте это. Именно поэтому настройка шрифтов проводится первее настройки раскладок.

### Постоянная конфигурация
Как я уже написал, первый способ заключается в единоразовом указании системе нужного шрифта, чтобы каждый раз после запуска нового сеанса не вводить команду в терминале. Итак, для этого откроем файл `/etc/sysconfig/console` и отредактируем содержимое параметра `FONT`:

```bash
vim /etc/sysconfig/console

# Вы увидите почти в самом конце строку:
FONT="..."
# (вместо многоточия там будет нужный шрифт.
# Замените его на тот, что вам нужен. Например,
# чтобы использовался шрифт cyr-sun16, эта
# строка должна иметь следующий вид:
FONT="cyr-sun16"
```

### Временная конфигурация
И второй способ. Это временная конфигурация. Она будет действовать только в текущем сеансе, не более. Но такой способ может быть полезен при тестировании различных шрифтов. Для того, чтобы установить шрифт, выполните:

```bash
setfont ИМЯ_ШРИФТА
```

Например:
```bash
setfont cyr-sun16
```

> **ВАЖНО!**

> Все *консольные* шрифты советуется брать из директории `/usr/share/consolefonts`. И устанавливать туда же. Этот совет только для того, чтобы держать систему в чистоте и порядке.

---

## Настройка раскладок

Если со шрифтами было всё очень просто, то с раскладками сначала я немного помучался. Ибо в LFS нужные конфиги расположены в других местах, да и настройка немного другая. А привык я к настройке Debian, ибо использовал его на протяжении долгого времени, а там немного по-другому. Но в этой инструкции будет всё просто.

Для начала. Соглашения об именах консольных раскладок клавиатуры я бы назвал немного *условными*. Но, обычно, они основаны на:
* Коде языка, где код раскладки совпадает с кодом страны (например, `ru` для русской и `en` для английской).
* Коде страны, где варианты одного и того же языка используются в различных странах (например, `uk` и `us` для одной и той же раскладки, но первая используется в Великобритании, а вторая в США).
* Раскладке клавиатуры, где она не связана с конкретной страной или языком (например, `dvorak`).

Для просмотра всех установленных раскладок, выполните:

```bash
find /usr/share/keymaps --type f
```
Либо с помощью программы `fd` из состава Calmira 2021.3:

```bash
fd . '/usr/share/keymaps' --type f
```

### Выбор русской раскладки
Теперь о выборе раскладки. Об этом я напишу на примере русской. Нужно выбрать нужную. Существует несколько русских раскладок:
* `ru` - переключение раскладки не установлено автором (либо же вовсе отсутствует)
* `ruwin_alt_sh-UTF-8` - переключение раскладки по Alt+Shift.
* `ruwin_cplk-UTF-8` - переключение раскладки по Caps Lock.
* `ruwin-ct_sh-UTF-8` - переключение раскладки по Ctrl+Shift.

Это всё одно и то же, у них только различаются методы переключения. Есть ещё и другие значения. Как вы поняли, они соответствуют таковым из директории `/usr/share/keymaps`.

Теперь же нужно применить изменения. И так же два способа: постоянный и временный. Как в предыдущем пункте о настройке шрифтов.

> **Примечание**

> Раскладка, которую мы устанавливаем, будет *дополнительной*. Это значит, что основной будет английская. Это нужно для удобной работы в терминале, ведь логин и пароль пользователя, все команды и пр. именно на английском. Однако, вам не следует устанавливать ещё и английскую раскладку - она уже установлена по умолчанию.

### Постоянная конфигурация
Назначение постоянного способа понятно - для обычного использования. Для этого необходимо объявить параметр `KEYMAP` в файле `/etc/sysconfig/console`. В качестве аргумента - раскладка клавиатуры (название файла из `/usr/share/keymaps/*` без расширения). Либо же то, что представлено чуть выше в пункте *"Выбор русской раскладки"* для русской. Например, я хочу, чтобы у меня была дополнительная русская раскладка, метод переключения: ALt+Shift. Тогда параметр `KEYMAP` будет выглядеть так:
```bash
KEYMAP="ruwin_alt_sh-UTF-8
```

> **ВАЖНО!**

> Для QWERTY клавиатуры выбирайте раскладку из `/usr/share/keymaps/i386/qwerty`.

Собственно, здесь всё просто. И тут я аплодирую стоя дистрибутиву LFS и тому, как в нём реализована настройка необходимых компонентов. Например, чтобы настроить клавиатуру в Debian, нужно либо пользоваться простым интерактивным псевдографическим `dpkg-reconfigure keyboard-configuration` (метод не самый хороший, так как не всегда правильно настраивает), либо же редактировать конфиг `/etc/default/keyboard`. И это при том условии, что Debian - это *классический* дистрибутив Linux. Но некоторые вещи вот так разрозненны между собой. Хотя это всё мелочи, я могу смело вам советовать Debian для использования как на десктопе, так и на других ПК.

> **Предупреждение.**

> Для корректного отображения кириллицы вам следует выбрать шрифт, способный отобразить её. Это может быть `cyr-sun16`, `UniCyr_8x16`, либо другие. О них смотрите дополнительную информацию в [гугле](https://www.google.com).


> **Смотрите также:**

> Для systemd есть инструмент под названием `localectl`. Воспользуйтесь им, чтобы настройить клавиатуру. Но настройка будет производиться уже совсем в другом конфиге: в `/etc/vconsole.conf`. Для того, чтобы изменить раскладку этим инструментом, выполните: `localectl set-keymap --no-convert ИМЯ_РАСКЛАДКИ`.

### Временная конфигурация
Так же существует временный способ переключения раскладок. Он может пригодиться, например, когда пользователь настроил систему, но по каким-то причинам применить настройки не может (невозможно в данный момент по определённым обстоятельствам перезайти в сеанс, например). Но самое главное предназначение временной конфигурации - это тестирование раскладок. Будь то своих самодельных (об этом поговорим в следующей статье), будь то чужих.

Для временного использования определённой раскладки воспользуйтесь программой `loadkeys`. Синтаксис прост:
```bash
loadkeys ИМЯ_РАСКЛАДКИ
```


> **Смотрите также:**

> man loadkeys

Например:

```bash
loadkeys ruwin_alt_sh-UTF-8
```

> **Предупреждение:**

> Обычно, `loadkeys` используется в системе инициализации `systemd`. И я не могу гарантировать правильную работу этого инструмента на других инитах, к примеру, на `SysVInit`.

---

## Окончательная конфигурация
Пришло время сделать некое резюме того, что я написал. Так будет понятнее, какие действия нужно предпринимать в файле `/etc/sysconfig/console`. Ну и более понятный алгоритм действий. Итак, два параметра (шрифт и раскладка) я установлю на постоянное использование в файл `/etc/sysconfig/console`. Для этого буду руководствоваться пунктами выше в этой статье.

Для корректного отображения символов, нужно переключить консоль в режим `UTF-8`. Для этого использую параметр:

```
UNICODE="1"
```

Помимо этого, мне нужно настроить раскладку клавиатуры. И не просто раскладку, а ту, которая способна переключаться на другую (в данном случае, основную английскую `us`). Поэтому мне пригодится раскладка `ruwin_alt_sh-UTF-8` (как значение параметра `KEYMAP`):

```
KEYMAP="ruwin_alt_sh-UTF-8
```

И шрифт. Я предпочитаю `cyr-sun16`. Передаю его как параметр `FONT`'y:

```
FONT="cyr-sun16
```

> **ВНИМАНИЕ!**

> Напомню, что шрифт должен поддерживать кириллицу.

В этом резюме я его указал последним, хотя для начала лучше, конечно, указать шрифт первее раскладки. Чтобы понимать, что делаешь. Впрочем, для меня это не главное, так как опыт в настройке консоли у меня есть, в т.ч., настройка шрифтов и раскладок. Так что сомневаюсь, что совершу ошибку. А вот первичную настройку я проводил уже иначе. Сначала - шрифт, а уж потом раскладку. Так как опыт был, но в настройке другого дистрибутива, где всё иначе.

Не забываю про комментарии `# Begin /etc/sysconfig/console` и `# End /etc/sysconfig/console`. Так принято. Ну и конфиг выглядит эстетичнее. А что лучше: копаться в красивом конфигурационном файле, либо же в какой-то помойке? Вот и думайте.

Итого, конфигурационный файл выглядит так:
```bash
# Begin /etc/sysconfig/console

UNICODE="1"
KEYMAP="ruwin_alt_sh-UTF-8"
FONT="cyr-sun16"

# End /etc/sysconfig/console
```

## Выводы
В данной статье вы узнали, как настраивать клавиатуру и шрифт в TTY Linux. Это было произведено на примере дистрибутива LFS. Помните, что на других дистрибутивах местонахождение нужного конфига может различаться. Как и сам процесс настройки. Если вам это понравилось, то отпишитесь в комментариях. И, может быть, в скором времени выйдут дополнительные статьи по настройке дистрибутива LFS.

Удачи!
