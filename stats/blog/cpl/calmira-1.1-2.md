# Опыт использования CalmiraLinux LX4 1.1. Часть 2 - процесс настройки.

В первой части статьи рассказал про опыт установки этой системы на ПК, сейчас же речь пойдёт о первичной настройке дистрибутива для дальнейших операций с ним. Например, настрою часовые зоны и прочее.

## Загрузка дистрибутива

Загрузка системы похожа на процесс загрузки всех других систем. Если не указан аргумент `quiet` ядра, то будут выводиться все его сообщения вперемешку с сообщениями системы инициализации SysVInit. Если аргумент `quiet` указан, то будут выведены сообщения системы инициализации, а так же какие-то предупреждающие сообщения.

Значение `LOGLEVEL` из файла `/etc/sysconfig/console` по умолчанию не установлено, а это значит, что в консоль будут перенаправляться сообщения dmesg. Это может оказать некоторые проблемы в процессе использования дистрибутива, поэтому после входа в систему настоятельно рекомендуется добавить строку:

```bash
LOGLEVEL=1
```

в файл `/etc/sysconfig/console`, дабы избежать вывода сообщений dmesg в консоль. В релизе LX4 1.2 этот параметр будет использован по умолчанию.

### Вход в систему

После полной загрузки системы вас будет ожидать `login`, запрашивающий аутентификационные данные определённого пользователя. Сейчас доступен только `root`. Логин: `root`, пароль: `root`.

> Настоятельно не рекомендуется использовать учётную запись `root` в качестве основной. В случае неправильного действия пользователя или какого-либо ПО это может оказать губительное действие на систему. После первичной настройки системы нужно обязательно создать обычного непривилегированного пользователя.

После логина вас будет ожидать оболочка `bash`. Кроме неё никаких не установлено, а `/bin/sh` является ссылкой на `/bin/bash`.

## Настройка системы

### Настройка часового пояса

Для настройки времени.

Введите команду:

```bash
tzselect
```

Следуйте указаниям программы для выбора вашего часового пояса. В конце она выдаст нужные результаты. Например, у меня это `Europe/Moscow`. Запомните вывод программы и выполните следующую команду:

```bash
ln -sfv /usr/share/zoneinfo/$ZONE /etc/localtime
```

Замените `$ZONE` на путь к вашему часовому поясу (из вывода `tzselect`.

### Настройка сети

> Для использования сети, возможно, придётся пересобрать ядро Linux.

Для работы с сетью в CalmiraLinux установлен следующий софт:

- `inetutils`;
- `dhcpcd`;
- `wpa_supplicant`.

Поговорим про `wpa_supplicant`:

- Это кросс-платформенная свободная реализация стандарта IEEE 802.11 для GNU/Linux, *BSD, Windows, MacOS X и прочих.
- Полная поддержка WPA2, WPA и некоторых других протоколов безопасности беспроводной LAN-сети.
- Приложение пользовательского пространства, выполняющее функции саппликанта и SME оператора, исполняющего MLME инструкции.

Поддерживает:

- WPA и полностью IEEE 802.11i/RSN/WPA2.
- WPA-PSK и WPA2-PSK (pre-shared key) ("WPA-Personal").
- WPA вместе с EAP (т.е., сервером аутентификации RADIUS) ("WPA-Enterprise") управление ключами CCMP, TKIP, WEP (104/128 и 40/64 бит).
- Кэширование RSN, PMKSA: предварительную аутентификацию.

Процесс установки связи с точкой доступа:

- Сетевой интерфейс *уже* исправно функционирует, нужные драйвера установлены в ядре, после чего `wpa_supplicant` должен запуститься.
- `wpa_supplicant` сканирует доступные Basic Service Set (BSS).
- Производит выбор BSS в соответствии с настройками.
- Запрашивает драйвер ядра установить соединение с выбранной BSS.
- И прочие действия.

**Процесс конфигурирования ядра**

В стоковом ядре уже включено всё нужное, но если вы решили собрать своё ядро, то убедитесь, что следующее включено:

```
[*] Networking support  --->                              [CONFIG_NET]
  [*] Wireless  --->                                      [CONFIG_WIRELESS]
    <*/M> cfg80211 - wireless configuration API           [CONFIG_CFG80211]
    [*]     cfg80211 wireless extensions compatibility    [CONFIG_CFG80211_WEXT]
    <*/M> Generic IEEE 802.11 Networking Stack (mac80211) [CONFIG_MAC80211]
Device Drivers  --->
  [*] Network device support  --->                        [CONFIG_NETDEVICES]
    [*] Wireless LAN  --->                                [CONFIG_WLAN]
```

**Процесс конфигурации `wpa_supplicant`**

Конфигурационные файлы: `/etc/sysconfig/wpa_supplicant-*.conf`. Где `*` - название нужного сетевого интерфейса. Например, в моём случае это будет `wlp2s0`, в других случаях будет, например, `wlan0` и прочее.

> **ВНИМАНИЕ!**

> Замените в файлах и конфигах `wlp2s0` на имя вашего сетевого интерфейса. Далее будет использоваться `wlp2s0`, вы ставите нужное.

Чтобы подключиться к точке доступа, которая использует пароль, вам необходимо предварительно поместить общий ключ в `/etc/sysconfig/wpa_supplicant-wlp2s0.conf`. `SSID` - строка, которую точка доступа или маршрутизатор передаёт для идентификации себя.

```bash
wpa_passphrase SSID SECRET_PASSWORD > /etc/sysconfig/wpa_supplicant-wlp2s0.conf
```

`/etc/sysconfig/wpa_supplicant-wlp2s0.conf` может содержать сведения о нескольких точках доступа. Когда `wpa_supplicant` будет запущен, он будет сканировать SSID, к которым можно подключиться, и выберет нужный пароль для подключения.

В случае, если вы используете точку доступа, не защищённую паролем, поместите следующую запись в `/etc/sysconfig/wpa_supplicant-wlp2s0.conf`. Замените `SOME_SSID` на имя точки доступа.

```
network={
  ssid="SOME_SSID"
  key_mgmt=NONE
}
```

Далее вам требуется создать файл `/etc/sysconfig/ifconfig-wlp2s0` (замените `wlp2s0` на имя нужного интерфейса. По аналогии с `wpa_supplicant`).

```bash
cat > /etc/sysconfig/ifconfig.wifi0 << "EOF"
ONBOOT="yes"
IFACE="wlp2s0"
SERVICE="wpa"

# Additional arguments to wpa_supplicant
WPA_ARGS=""

WPA_SERVICE="dhcpcd"
DHCP_START="-b -q <нужные ключи запуска>"
DHCP_STOP="-k <нужные ключи остановки>"
EOF
```

В том случае, если вы используете статические адреса в локальной сети, создайте файл `/etc/sysconfig/ifconfig-wlp2s0` со следующем содержимым:

```bash
cat > /etc/sysconfig/ifconfig.wifi0 << "EOF"
ONBOOT="yes"
IFACE="wlp2s0"
SERVICE="wpa"

# Additional arguments to wpa_supplicant
WPA_ARGS=""

WPA_SERVICE="ipv4-static"
IP="192.168.1.1"
GATEWAY="192.168.1.2"
PREFIX="24"
BROADCAST="192.168.1.255"
EOF
```

Подключиться к сети можно с помощью следующей команды:

```bash
ifup wlp2s0
```

Замените `wlp2s0` на имя вашего сетевого интерфейса. Напоминаю, что в файлах `/etc/sysconfig/wpa_supplicant-*.conf` и `/etc/sysconfig/ifconfig-*` должно быть то же название. Это может быть `wifi0` и другие.

Далее подключение будет автоматическим во время загрузки системы.

> **Смотрите также:**

> Для более удобной работы с Wi-Fi можете установить порт `network/connecting/WT` (Wireless Tools-29). Он включает в себя программы `ifrename`, `iwconfig`, `iwevent`, `iwgetid`, `iwlist` и другие. `iwlist`, например, предназначена для получения подробной информации о беспроводной точке доступа.

### Настройка количества TTY

> **ВНИМАНИЕ!**

> В данном пункте редактируется файл `/etc/inittab`. При неправильных параметрах в котором система может неправильно загружаться и функционировать. Редактируйте этот файл в случае действительной необходимости.

Система инициализации SystemVInit читает параметры из файла `/etc/inittab`. Так же там описан запуск программ `sulogin` (программа для логина пользователей), `agetty` (алтернатива `getty` - программа, управляющая доступам к TTY).

По умолчанию в этом файле содержатся базовые настройки, которые будут оптимальными для большинства пользователей. Для того, чтобы отредактировать его, выполните:

```bash
vim /etc/inittab
```

Редактирование этого файла может быть полезным, если требуется изменить число TTY, например. По умолчанию их 6:

```bash
1:2345:respawn:/sbin/agetty --noclear tty1 9600
2:2345:respawn:/sbin/agetty tty2 9600
3:2345:respawn:/sbin/agetty tty3 9600
4:2345:respawn:/sbin/agetty tty4 9600
5:2345:respawn:/sbin/agetty tty5 9600
6:2345:respawn:/sbin/agetty tty6 9600
```

Для добавления новых TTY добавьте строку формата:

```bash
$NUMBER:2345:respawn:/sbin/agetty tty$NUMBER 9600
```

Замените `$NUMBER` на номер TTY.

Переключаться между TTY можно сочетанием клавиш Ctrl+Alt+F`n`, где `n` - номер функциональной клавиши, равный номеру TTY, или Alt+Left / Alt+Right.

## Работа с софтом

В версии LX4 1.1 было представлено следующее средство управления ПО - система портов. Вообще, она используется во всех source-based дистрибутивах (либо что-то напоминающее это). От бинарных пакетов было принято решение отказаться, к тому же, не было нормального инструментария для управления ими.

На самом деле, даже система портов CalmiraLinux очень далеко не идеальна. Например, на данный момент нет никакой обработки зависимостей, нет возможности просмотреть информацию о порте (кроме просмотра файла `config.json`), нет возможности удалить пакет (к релизу CalmiraLinux LX4 2.0 эти проблемы будут решены). Однако система портов совершенствуется и скоро обрастёт новыми функциями.

Система портов находится в `/usr/ports`. Всё ПО разделено на категории:

* `base` - базовые порты, входящие в минимальную поставку дистрибутива;
* `console` - консольные утилиты;
	* `editors` - консольные текстовые редакторы;
* `kernel` - ядро и его компоненты;
* `multimedia` - мультимедиа утилиты;
* `network` - сетевые утилиты;
	* `browsers` - браузеры и менеджеры скачивания;
	* `connecting` - утилиты для подключения к сети;
* `optional` - дополнительный софт, не вошедший в базовую поставку дистрибутива, но который может понадобиться после установки системы;
	* `libs` - библиотеки;
* `programming` - программирование: языки, доп. компиляторы (не вошедшие в минимальную поставку дистрибутива), модули, предназначенные для разработки библиотеки.
	* `python-modules` - модули для ЯП Python. Часть используются в составе некоторых пакетов;
* `xorg` - сервер X и другое ПО, такое как оконные менеджеры и рабочие окружения;
	* `x11-de` - рабочие окружения для X11;
	* `x11-minimal` - X-сервер и основные утилиты для него;
		* `xlibs` - дополнительные библиотеки Xorg, которые не входят в минимальную поставку Xorg, но которые могут пригодиться при сборке других пакетов (таких как рабочих окружений);
		* `xdrivers` - драйвера Xorg;
	* `x11-wm` - оконные менеджеры Xorg;

В каждой категории несколько подкаталогов с портом программы. Первые версии портов включают в себя только файл `install` с инструкциями по сборке, либо ещё `info` с информацией о пакете. В новых портах вместо `info` используется файл `config.json`, который предназначается ещё и для занесения пакета в базу данных `port-utils`.

### Установка программ из портов

Для того, чтобы установить какую-либо программу из порта, нужно выполнить:

```bash
# Переход в нужную директорию
cd /usr/ports/$КАТЕГОРИЯ/$ПРОГРАММА

# Выполнение инструкций сборки и установки
./install
```

Так же в директории с портом могут находиться следующие файлы:

* `install_doc.sh` - для установки дополнительной документации;
* `setup.html` - инструкции по дальнейшей настройке пакета, которые трудно автоматизировать (нужно активное участие пользователя/администратора для выбора и изменения параметров, например), либо автоматизировать невозможно/не рекомендуется. Пригоден для открытия во всех известных браузерах.
* `setup.sh` (не путать с предыдущим `setup.html`!) - содержит инструкции для автоматизированной настройки пакета после установки для КОНКРЕТНОГО пользователя, от чьего имени запускается этот скрипт. Обычно создаёт нужные директории и конфигурационные файлы в домашней папке (`~/`) того пользователя.
* `info` (устаревший) - содержит описание пакета и его версию. На данный момент заменён на `config.json`, предоставляющий более обширные данные в удобном формате json. Так же используется для добавления пакета в базу данных `port-utils`.

Всё ПО из портов собирается из исходного кода. В некоторых случаях сборка может занять довольно много времени (так, например, пакет `gcc` на очень слабом железе может собираться до трёх дней). Однако, у сборки очень много преимуществ:

1. Возможность оптимизации программы под своё железо;
2. Больший контроль при установке;
3. Выбор нужных функций и удаление ненужных (если программа это поддерживает).

Иногда пакеты предоставляют к установке дополнительную документацию. Она не всем нужна, поэтому мы оставили в портах возможность выбора пользователем: ставить её или нет. Система портов всегда спрашивает пользователя об этом. Если вы отказались от установки такой документации в будущем, но она вам пригодилась позже - перейдите в директорию с портом и выполните:

```bash
chmod +x install_doc.sh
./install_doc.sh
```

Этими командами вы установите документацию пакета.

### Конфигурация порта

Все сведенья и параметры порта находятся в файле `config.json`. Его примерное содержимое здесь:

```json title="config.json"
{
    "name": "имя порта *",
    "version": "версия порта *",
    "description": "описание порта *",
    "maintainer": "сопровождающий порт *",
    "priority": "приоритет порта *",
    "release": "релиз Calmira, для которого предназначен порт",
    "deps": {
        "required": [
            "необходимые зависимости"
        ],
        "runtime": [
            "необходимые зависимотси в рантайме"
        ],
        "optional": [
            "опциональные зависимости"
        ],
        "recommend": [
            "рекомендуемые зависимости"
        ],
        "before": [
            "порт должен быть установлен перед этими зависимостями"
        ],
        "conflict": [
            "конфликтующие с этим портом зависимости"
        ]
    },
    "bins": [
    	"список установленных программ (бинарных файлов) в /bin, /sbin, /usr{,/local}/bin, /usr{,/local}/sbin"
    ],
    "libs": [
    	"список установленных библиотек"
    ],
    "dirs": [
    	"список установленных директорий"
    ]
}
```

Все значения, указанные знаком `*` являются обязательными. Остальные вы используете по мере необходимости.

Подробное объяснение параметров в таблице ниже.

| Параметр | Объяснение | Приоритет |
|----------|------------|-----------|
| `name` | Имя пакета. Важно не путать имена пакета и порта. Например, имя пакета - `vim`, а имя порта - `/base/editors/vim` | Необходимый |
| `version` | Версия пакета | Необходимый |
| `description` | Описание пакета (для чего он предназначен). Только на английском или русском языках. | Необходимый |
| `maintainer` | Имя/псевдоним, а так же почта сопровождающего порта | Необходимый |
| `priority` | Приоритет порта - пользовательский или системный | Необходимый |
| `release` | Порт подготовлен только для определённого релиза дистрибутива CalmiraLinux, на других работа будет некорректной. Номер релиза системы берётся из параметра `DISTRIB_RELEASE` файла `/etc/lsb-release`. | Опциональный |
| `deps` | В этой секции описываются зависимости порта (см. пункт "Зависимости поля `deps`") | Опциональный |
| `bins` | Установленные программы в `/{bin,sbin}` и `/usr/{bin,sbin}` | Опциональный |
| `libs` | Установленные библиотеки | Опциональный |
| `dirs` | Установленные директории | Опциональный |

!!! note "Обратите внимание"
	Если у параметра установлен необходимый приоритет, то этот параметр **обязательно** должен присутствовать в `config.json`. Опциональные параметры выбираются, если сопровождающий считает нужным, а так же по мере наличия нужной информации для заполнения значений этих параметров.

#### Зависимости поля `deps`

Примерное содержимое поля `deps`:

```json title="Фрагмент config.json: содержимое поля 'deps'"
"deps": {
    "required": [
        "необходимые зависимости"
    ],
    "runtime": [
        "необходимые зависимотси в рантайме"
    ],
    "optional": [
        "опциональные зависимости"
    ],
    "recommend": [
        "рекомендуемые зависимости"
    ],
    "before": [
       "порт должен быть установлен перед этими зависимостями"
    ],
    "conflict": [
        "конфликтующие с этим портом зависимости"
    ]
},
```

**Параметры:**

| Параметр | Объяснение |
|----------|------------|
| `required` | Необходимые зависимости, без которых порт не может быть собран и установлен. Перед сборкой данного порта, соберите его необходимые зависимости из этого параметра. |
| `runtime` | Необходимые зависимости во время работы компонентов пакета |
| `optional` | Опциональные зависимости. Не обязательны к сборке и установке. Обычно расширяют функционал искомого порта. |
| `recommend` | Рекомендуемые зависимости. Так же не обязательны к сборке и установке, но без них пакет порта может работать нестабильно/некорректно, либо не будут доступны определённые функции и возможности |
| `before` | Необязательные зависимости. Тоже самое, что `optional` и `recommend`, но разница в том, что опциональные и рекомендуемые зависимости могут быть установлены после сборки искомого порта, а `before` - либо установлены **до** искомого порта, либо не установлены вообще. |
| `conflict` | Эти порты конфликтуют с искомым. Возможно они/искомый порт затирают файлы друг друга, либо вызывают всевозможные несовместимости и регрессии. Настоятельно советуется удалить те порты, которые установлены в системе и перечислены в этой секции во избежание ошибок |
