# Опыт использования CalmiraLinux LX4 1.1. Часть 1 - установка.

<pre>
<strong>Автор:</strong> <a href="/LinuxSovet/Group/authors.d/Linuxoid85.html">Михаил Краснов</a>
<strong>Дата написания:</strong> 24.11.2021 21:20
</pre>

Мало кто знает, но я так же занят разработкой независимого дистрибутива CalmiraLinux. Это source-based дистрибутив, следующий идеологии KISS.

Несмотря на ограниченные сроки выхода и отсутствие времени у меня, релизнул версию LX4 1.1 тогда, когда обещал. Несмотря на то, что некоторые изменения так и не смог реализовать, они будут реализованы в следующих релизах. Например, корректирующий релиз LX4 1.2 (который выйдет 15 марта 2022), привнесёт улучшенный опыт работы с системой портов, улучшенную поддержку распространённых моделей сетевых карт и прочие улучшения. Не обойдётся без обновлений пакетов до новых версий.

## Особенности

Из особенностей дистрибутива можно отметить:

- Использование системы портов вместо классической парадигмы управления программным обеспечением. На данный момент не предоставляется ни одного готового бинарного пакета. Всё, что нужно установить пользователю, собирается из исходного кода. Возможно, что в будущем будут предлагаться к использованию бинарные сборки некоторых "тяжёлых" пакетов, которые трудно и долго собирать, но эта идея отложена на будущее и пока реализована не будет.
- Предоставление только свободного ПО как в минимальной поставке дистрибутива, так и в системе портов. Исключением можгут быть несвободные компоненты ядра Linux.
- Предоставление "классической" системы инициализации SysVInit.
- Модульная структура системы. Дистрибутив построен на основе [CPL](https://github.com/CalmiraLinux/CPL) - монолитного, автомарно обновляемого образа с набором минимально возможного ПО для работы системы. Он не включает в себя ядро Linux, загрузчик и систему инициализации.
- Как вы могли заметить, в названии системы так же присутствует пометка `LX4`. Это значит, что CPL собирался с использованием инструкций [LX4U](https://lx4u.ru). Использованная версия: Dev (на момент выхода релиза CalmiraLinux - это будущая версия 2.0). Планировалось использование версии 1.3, но по некоторым причинам была выбрана именно dev.
- Распространение образов в виде `squashfs`-снимков. Пользователь сам должен распаковать их, подготовить разделы и скопировать туда содержимое снимков, а далее приступить к настройке системы.

## Позиционирование

Дистрибутив ориентирован на опытного пользователя или гика, а так же владельцев слабого железа. В CalmiraLinux представлена большая свобода действий для пользователей, большое число компонентов ОС поддаётся настройке.

> Этот дистрибутив **НЕ** подойдёт начинающему пользователю.

## Список изменений версии LX4 1.1

1. Переход на более безопасную и надёжную классическую (CDS, classical directory structure) структуру директорий системы, в которой каталоги /bin, /sbin, /usr/sbin и /lib не являются ссылками на /usr/bin и /usr/lib соотв. (в релизе LX4 1.0 был выполнен незапланированный переход на упрощённую).
2. Включение в состав системы портов - нового средства управления софтом. Сейчас предназначена только для автоматизации сборки программ.
3. Обновление большинства пакетов. В частности, ядро linux обновлено до версии 5.15.1.
4. Удаление из системы портов рабочего окружения GNOME Shell.
5. `fstab` и часовые зоны не настроены по умолчанию. Пользователю требуется настроить это самостоятельно.
6. По умолчанию применяются настройки консоли для русскоязычного пользователя.
7. Использование термина `BCPL` (Beyond Calmira PLatform) вместо `CalmiraLinux` в некоторых компонентах системы.

И другие. Смотрите [релиз](https://github.com/CalmiraLinux/CalmiraLinux/releases/tag/v1.1).

## Не реализовано

К сожалению, есть и то, что планировалось включить в этот релиз, но из-за отсутствия времени изменения перенесены в следующую LX4 2.0 версию.

- Формирование полноценного загрузочного iso-образа.
- Написание установщика системы.
- Выход `port-utils v1.0`, инструмента для работы с системой портов, и его включение в минимальную поставку дистрибутива.
- Подготовка сборочных скриптов для автоматизации создания тестовых сборок системы.

***

## Скачивание

Скачать образ системы можно [отсюда](https://github.com/CalmiraLinux/CalmiraLinux/releases/tag/v1.1). Заметьте, что это НЕ raw-образ, поэтому использовать его для записи на флешку не получится. Это образ squashfs.

## Подготовка образа

Два способа:

1. Распаковка образа.
2. Монтирование образа.

Я опишу два способа извлечения файлов.

### 1. Распаковка образа

Тут всё просто. Для извлечения данных этим способом нужен пакет `squashfs-tools` с **обязательной** поддержкой метода сжатия `xz`. Например, в Debian `squashfs-tools` собираются с поддержкой этого формата сжатия, а в большинстве rpm-дистрибутивов типа Альта, Fedora и прочих - нет. В таком случае в [Makefile](https://github.com/Othernet-Project/squashfs-tools/blob/master/squashfs-tools/Makefile#L29) раскомментируйте строку:

```makefile
########### Building XZ support #############
#
# LZMA2 compression.
#
# XZ Utils liblzma (http://tukaani.org/xz/) is supported
#
# To build using XZ Utils liblzma - install the library and uncomment
# the XZ_SUPPORT line below.
#
#XZ_SUPPORT = 1
```

Чтобы получилось так:

```makefile
########### Building XZ support #############
#
# LZMA2 compression.
#
# XZ Utils liblzma (http://tukaani.org/xz/) is supported
#
# To build using XZ Utils liblzma - install the library and uncomment
# the XZ_SUPPORT line below.
#
XZ_SUPPORT = 1
```

После чего банальные (от имени `root`):

```bash
make && make install
```

И можно распаковывать:

```bash
sudo unsquashfs  calmira-lx4-1.1-cds.sfs 
```

В итоге появится директория `squashfs-root` общим содержимым около 1.1 Гб.

### 2. Монтирование образа

Для начала создадим точку монтирования. Для наглядности это будет директория с именем `squashfs-root`. Впрочем, название некритично.

```bash
mkdir ./squashfs-root
```

И монтирую образ:

```bash
sudo mount calmira-lx4-1.1-cds.sfs squashfs-root -v
```

После чего можно производить дальнейшие действия.

## Копирование файлов

> Здесь инструкции для установки дистрибутива на реальный ПК. Если вы желаете установить дистрибутив в виртуалку, то посетите [эту](https://calmiralinux.github.io/handbook/site/installation/install-qemu/) страницу для получения дополнительных сведений.

Для начала подготовьте необходимые разделы в соответствии с таблицой ниже.

| Раздел | Размер | Тип |Описание | Приоритет |
|--------|--------|-----|---------|-----------|
| `/`    | Более 1.3 Гб | Linux filesystem |Корневой раздел, куда устанавливается система | Необходимый |
| `/swap` | Половина объёма ОЗУ | Linux swap | Раздел подкачки (о работе оперативной памяти и подкачки читайте [здесь](https://linuxoid85.github.io/LinuxSovet/stats/RAM/ram.html)) | Опциональный |
| `/home` | Linux filesystem | На усмотрение пользователя; оставшееся незанятое пространство на ЖД | Содержит пользовательские данные. Можно и не выносить в отдельный раздел | Необязательный |

Можете создать и другие разделы.

> Требуемые разделы требуется указать в файле `/etc/fstab` установленной системы CalmiraLinux. Про это читайте [здесь](https://calmiralinux.github.io/handbook/site/installation/setting-up/#fstab).

После чего отформатируйте эти разделы. Для корневого и `/home` раздела настоятельно советуется файловая система `ext4`. Позже в ядро будет добавлена поддержка других популярных ФС.

Например:

```bash
mkfs.ext4 /dev/sdX
```

Замените `sdX` на нужный раздел. Например, `sdb1`.

Для форматирования подкачки выполните:

```bash
mkswap /dev/sdZ
```

Замените `sdZ` на нужный раздел, например, `sdb2`.

Далее создайте некоторую директорию `/mnt/calm`, смонтируйте в неё необходимые разделы, предварительно создав нужные точки монтирования (о монтировании смотрите [здесь](https://calmiralinux.github.io/handbook/site/installation/install-pc/#_2)), скопируйте туда содержимое образа:

```bash
export CALM="/mnt/calm"
mkdir $CALM

cp -rxva ./squashfs-root/* $CALM/
```

## Смена корня⚓

Первым делом необходимо загрузиться в только что скопированную Calmira. Сейчас же нельзя это сделать, так как система не загрузится - нужно настроить `fstab` и загрузчик. Поэтому на хост-системе произведём операцию смены корня.

> **Обратите внимание!**

> Для начала вы должны смонтировать раздел жёсткого диска или образ виртуального диска qcow2 в вашу систему. Точка монтирования: `/mnt/calm`. О монтировании сказано в предыдущих инструкциях.

```bash
for DIR in "dev" "dev/pts" "proc" "sys"; do
	sudo mount -v --bind /$DIR /mnt/calm/$DIR
done

if [ -h /mnt/calm/dev/shm ]; then
 	mkdir -pv /mnt/calm/$(readlink /mnt/calm/dev/shm)
fi

chroot "/mnt/calm" /usr/bin/env -i \
    HOME=/root TERM="$TERM"             \
    PS1='(chroot) \u:\w\$ '             \
    PATH=/bin:/sbin:/usr/bin:/usr/sbin  \
    /bin/bash --login
```

Вы окажетесь в скопированной Calmira GNU/Linux. Вы изолированы от хост-системы, и можете настраивать дистрибутив так, как вам удобно.

## Настройка file systems table

`fstab` (file systems table) - один из конфигурационных файлов, содержащий информацию о различных файловых системах и устройствах хранения информации ПК. Он описывает, как диск будет использоваться или как будет интегрирован в систему. Файл `/etc/fstab` делает возможным автоматическое монтирование определенных файловых систем, что особенно нужно при загрузке системы. Он содержит ряд строк, описывающих файловые системы, их точки монтирования и другие параметры.

Каждый пункт содержит:

1. Устройство монтируемой ФС;
2. Точку монтирования;
3. Тип ФС;
4. Параметры монтирования;
5. Флаг для `dump`, утилиты для создания резервных копий;
6. Порядок проверки для `fsck` (File System ChecK).

Здесь всегда есть запись о корневой файловой системе. Раздел swap является специальным, поэтому его не видно в древовидной структуре, и в поле точки монтирования для таких разделов всегда содержится ключевое слово swap.

Необходимо настроить fstab, чтобы система корректно загружалась. Настройка будет примерно одинаковой как для способа установки системы на раздел жёсткого диска, так и для способа установки системы в виртуальную машину Qemu.

### Настройка fstab

Создайте файл `/etc/fstab` со следующим содержимым:

```bash
# Begin /etc/fstab

# file system  mount-point  type     options             dump  fsck order

/dev/sdX       /            ext4     defaults            1     1
proc           /proc        proc     nosuid,noexec,nodev 0     0
sysfs          /sys         sysfs    nosuid,noexec,nodev 0     0
devpts         /dev/pts     devpts   gid=5,mode=620      0     0
tmpfs          /run         tmpfs    defaults            0     0
devtmpfs       /dev         devtmpfs mode=0755,nosuid    0     0
```

Замените `/dev/sdX` из первой строки `fstab` на метку корневого раздела, на который устанавливалась система. Например, `/dev/sda3`. Если вы устанавливаете систему в виртуальную машину, то метка корневого раздела будет называться примерно так: `/dev/nbd0pX`, где X - номер нужного раздела.

Если у вас UEFI, то добавьте соотв. запись в fstab:

```bash
echo "/dev/sdN     /boot/efi      vfat    umask=0077           0     0" >> /etc/fstab
```

Замените `/dev/sdN` из команды выше на нужную метку раздела EFI. Повторимся, что его объём жолжен быть равен 256 Мб, файловая система - Fat32 (vfat).

Если вы используете swap-раздел, то выполните:

```bash
echo "/dev/sdM     swap         swap     pri=1               0     0" >> /etc/fstab
```

Замените `sdM` на нужную метку раздела с подкачкой (swap).

### "Монтировать в ОЗУ или не монтировать?" - вот в чём вопрос

Как вы могли заметить в `/etc/fstab`, некоторые директории монтируются в оперативную память (посредством `tmpfs`). У такого способа главное достоинство в том, что при монтировании этих каталогов в `tmpfs`, система будет работать несколько быстрее. На современном оборудовании это не так заметно, но на старом и слабом может сделать систему немного быстрее.

Недостаток в том, что на несколько Мб система будет потреблять больше. Так, например, если система потребляла 28 Мб, то с монтированием в tmpfs будет потреблять 30 Мб. Потребление зависит от содержимого тех директорий.

Владельцам оборудования с небольшим объёмом ОЗУ (меньше 64 мегабайт) просьба учитывать этот факт и трезво оценить достоинства и недостатки выноса некоторых директорий в ОЗУ.

### Дополнительно о метке корневого раздела с системой

Мы настоятельно советуем использовать вместо метки корневого раздела, на который установлена Calmira GNU/Linux (например, `/dev/sda1`, `/dev/hdc2`, etc.), его UUID. Если метка диска, прописанного в `/etc/fstab` изменится, то могут возникнуть проблемы с загрузкой ОС, либо же она не загрузится вообще.

Узнать UUID для нужного раздела можно, выполнив:

```bash
blkid /dev/sdX
```

Вывод будет примерно таким:

```
/dev/sda3: UUID="1ed63fa7-e4c9-43cc-96f4-9f951224a338" BLOCK_SIZE="4096" TYPE="ext4" PARTLABEL="Calmira data" PARTUUID="56ae06ac-dbd8-11eb-96fc-e8039ae29c93"
```

Вам понадобится что-то вроде этого:

```
UUID="1ed63fa7-e4c9-43cc-96f4-9f951224a338"
```

Запишите эту строку вместо `/dev/sdX` в fstab (но без кавычек). Напимер, fstab с UUID корневого раздела вместо его метки будет выглядеть так:

```bash
# Begin /etc/fstab

# file system                              mount-point  type     options             dump  fsck order

UUID=1ed63fa7-e4c9-43cc-96f4-9f951224a338  /            ext4     defaults            1     1
proc                                       /proc        proc     nosuid,noexec,nodev 0     0
sysfs                                      /sys         sysfs    nosuid,noexec,nodev 0     0
devpts                                     /dev/pts     devpts   gid=5,mode=620      0     0
tmpfs                                      /run         tmpfs    defaults            0     0
devtmpfs                                   /dev         devtmpfs mode=0755,nosuid    0     0
```

Замените `UUID=1ed63fa7-e4c9-43cc-96f4-9f951224a338` на полученное значение.

Этот способ является более надёжным, чем использование обычных меток дисков/разделов, которые могут в определённых ситуациях меняться.

## Установка загрузчика GRUB

В Calmira используется классический загрузчик GRUB2. Без него система не сможет загрузиться. Процесс установки для MBR BIOS, Legacy BIOS/GPT BIOS, UEFI различаются. Здесь будут описаны все эти три случая.

### Установка загрузчика в MBR

Для того, чтобы установить загрузчик, выполните:

```bash
grub-install /dev/sdX
```

Замените `sdX` на нужный диск. Например, `sda` или `nbd0`.

### Установка загрузчика Legacy BIOS

Если вы по каким-то причинам используете Legacy BIOS, либо же обычный BIOS, но у жёсткого диска таблица разделов GPT, то для установки загрузчика вам необходимо иметь раздел объёмом 1 Мб без файловой системы в начале диска. Если у вас на ПК уже установлена какая-либо ОС, то этот раздел должен присутствовать.

Установите загрузчик командой:

```bash
grub-install /dev/sdX
```

Замените `sdX` на нужный диск. Например, `sda` или `nbd0`.

### Установка загрузчика EFI

На данный момент все современные ПК имеют UEFI, а не BIOS. Для установки системы на UEFI, вы должны иметь доп. раздел объёмом 256 Мб с файловой системой `fat32` и названием `ESP`. Если у вас на ПК уже установлена какая-либо ОС, то этот раздел уже имеется. Смонтируйте его в `/boot/efi` командой `mount`. После чего необходимо установить несколько пакетов из системы портов для правильной работы загрузчика.

Установите из все порты из `base/grub-efi` в следующем порядке:

1. `efivar`;
2. `popt` (находится не в `base/grub-efi`, а в `general_libs`);
3. `efibootmgr`;
4. `grub`.

Для установки перейдите в директорию с портом:

```bash
cd /usr/ports/$КАТЕГОРИЯ/$ПОРТ
```

И выполните скрипт `install`:

```bash
./install
```

* `$КАТЕГОРИЯ` - категория, в котором располагается порт. Например, `base/grub-efi` или `general_libs`.
* `$ПОРТ` - имя нужного порта. Например, `efibootmgr`.

После чего можно устанавливать загрузчик:

```bash
grub-install /dev/sdX
```

Замените `sdX` на нужный диск. Например, `sda` или `nbd0`.

## Создание конфига GRUB (актуально для установки загрузчика на MBR или Legacy BIOS)

Конфиг `/boot/grub/grub.cfg` должен иметь следующий вид:

```bash
# Begin /boot/grub/grub.cfg
set default=0
set timeout=3

insmod ext2
set root=(hd0,2)

menuentry "Calmira LX4 1.1 GNU/Linux, Linux" {
        linux /boot/vmlinuz root=/dev/sda2 ro quiet
}
```

Где:

- `set default=0` - устанавливает стандартный выбранный пункт меню (порядковый номер от нуля до Х, либо `saved` для выбора предыдущего выбранного пункта).
- `set timeout=3` - устанавливает время ожидания до автоматического выбора определённого пункта меню, равное 3 секундам.
- `insmod ext2` - установка ФС.
- `set root=(hd0,2)` - установка корневого раздела.
- `linux /boot/vmlinuz` - загружаемое ядро, которое в Calmira всегда находится в `/boot/vmlinuz`.
    - `root=/dev/sda2` - установка корневого раздела для загрузки.
    - `quiet` - т.н. "тихий" режим, в котором не выводятся сообщения ядра о загрузке модулей и железа. В CalmiraLinux по умолчанию выводятся только предупреждения и ошибки.

> **Обратите внимание!**

> Замените значение параметра `root` на то, что нужно в вашем случае. Укажите корневой раздел, куда копировалась система.

## Завершение

Установка и загрузка системы завершена. Теперь вы можете выйти из `chroot` и перезагрузить компьютер.

## Выход из chroot

Для того, чтобы выйти из chroot, введите:

```bash
logout

umount /mnt/calm/dev{/pts,}
umount /mnt/calm/{sys,proc,run}
```

## Размонтирование

Теперь можно отмонтировать раздел/образ ЖД:

```bash
# Если установка производилась в раздел жёсткого диска:
umount /dev/sdX

# Если установка производилась в Qemu:
umount /mnt/calm # Размонтирование образа виртуального жёсткого диска
qemu-nbd --disconnect /dev/nbd0 # Отключение образа ВЖД
rmmod nbd # Отключение модуля nbd
```

## Перезагрузка

Введите:

```bash
reboot
```

Для перезагрузки.

***

Далее переписывать [CalmiraLinux Handbook](https://calmiralinux.github.io/handbook/site/) я не буду, вы и сами его читать умеете. Поэтому настройка будет пропущена, она есть в хандбуке. Который, кстати, не закончен, но основная информация там есть, страницы из старого руководства я перенесу чуть позже, когда психическое состояние будет лучше.

## Выводы

В данной части статьи я описал процесс установки дистрибутива CalmiraLinux на ПК, либо вирутальную машину. Как вы могли заметить, процесс установки прост и понятен, а скоро будет готов консольный установщик, призванный автоматизировать установку собранного дистрибутива, либо сборку подготовленных для этого пакетов. Во второй части опишу опыт использования данного дистрибутива с точки зрения гика, либо какого-либо фанатика. Выход этой части зависит и от моего психического состояния, и от вашей активности.

Удачи!
